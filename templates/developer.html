{% extends 'layout.html' %}

{% block body %}
<div class="jumbotron">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <h1 class="text-center">Developer Mode</h1>
            </div>
        </div>
        <p></p>
        <div class="row">
            <div class="col-sm-4">
                <b>Select module:</b>
                <button class="btn btn-primary dropdown-toggle" type="button" id="moduleSelectButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Module
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" data-name="Wright" href="#">Wright</a>
                    <a class="dropdown-item" data-name="Earhart" href="#">Earhart</a>
                    <a class="dropdown-item" data-name="None" href="#">None</a>
                </div>
            </div>
            <div class="col-sm-2">
                <button class="btn btn-danger" type="button" id="moduleDetectButton">
                    Disconnected
                </button>
            </div>  
            <div class="col-sm-6">
                
            </div>     
        </div>
        <p></p>
        <div class="row">
            <div class="col-sm-4">
                <b>Select firmware:</b>
                <input type="file" id="fileUploadButton" accept=".bin" onchange="handleUpload(this.files)">
                <label class="btn btn-secondary" for="fileUploadButton" id="fileUploadLabel">Firmware</label>
            </div>  
            <div class="col-sm-2">
                <button class="btn btn-secondary" type="button" id="programButton">
                    Program
                </button>
            </div>  
            <div class="col-sm-6">
                <label id="fileDateLabel">Modified: </label>
            </div>
        </div>
        <p></p>
        <div class="row">
            <div class="col-sm-4">
                <textarea class="form-control" id="provisionURL" rows="1" placeholder="Provision URL"></textarea>
            </div>  
            <div class="col-sm-2">
                <button class="btn btn-secondary" type="button" id="provisionButton" onclick="handleProvision()">
                    Provision
                </button>
            </div>  
            <div class="col-sm-6">
            </div>
        </div>
    </div>
</div>

<script>
    var socket = io();

    socket.on('js_module_present', function() {
        $('#moduleDetectButton').text("Connected");
        $('#moduleDetectButton').removeClass("btn btn-danger").addClass("btn btn-success");
    });

    socket.on('js_module_not_present', function() {
        $('#moduleDetectButton').text("Disconnected");
        $('#moduleDetectButton').removeClass("btn btn-success").addClass("btn btn-danger");
    });

    $(document).ready( () => {
        socket.emit('is_module_present');
    })

    $('.dropdown-item').click((event) => {
        var name = event.currentTarget;
        var module = name.getAttribute("data-name");

        if(module == "None")
        {
            $('#moduleSelectButton').text("Module");
            $('#moduleSelectButton').removeClass("btn btn-success dropdown-toggle").addClass("btn btn-primary dropdown-toggle");
        }
        else 
        {
            $('#moduleSelectButton').text(name.getAttribute("data-name"));
            $('#moduleSelectButton').removeClass("btn btn-primary dropdown-toggle").addClass("btn btn-success dropdown-toggle");
        }
    });

    function handleUpload(file) {
        var filename = file[0].name;
        var extension = filename.split('.')[1].toLowerCase();
        var date = file[0].lastModifiedDate.toString().slice(0, 33);

        if(extension != 'bin') 
        {
            $('#fileUploadLabel').removeClass("btn btn-secondary").addClass("btn btn-danger");
            $('#fileUploadLabel').text("Invalid");
            $('#fileDateLabel').text("Modified: ");
            return; 
        }

        $('#fileUploadLabel').removeClass("btn btn-danger");
        $('#fileUploadLabel').removeClass("btn btn-secondary").addClass("btn btn-success");
        $('#fileUploadLabel').text(filename);
        $('#fileDateLabel').text("Modified: " + date);

        console.log(file[0])
        socket.emit('firmware_upload', file[0])
    };

    function isValidURL(string) {
        var res = string.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);
        return (res !== null)
    };

    function handleProvision() {
        var candidate_url = $('#provisionURL')[0].value
        
        if(isValidURL(candidate_url)) {
            $('#provisionButton').removeClass("btn btn-danger")
            $('#provisionButton').removeClass("btn btn-secondary").addClass("btn btn-success");
        }
        else {
            $('#provisionButton').removeClass("btn btn-secondary")
            $('#provisionButton').removeClass("btn btn-success").addClass("btn btn-danger");
            return;
        }
    };
</script>
{% endblock %}


